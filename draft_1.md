# Rethink Query Optimization in HTAP Databases

## Background

## Problems of HTAP-agnostic Hybrid Plans

## MetisDB

![alt](./pics/屏幕截图%202025-06-22%20163431.png)

Metis算法基于MetisDB，遵循存算分离架构

行存储：LSM-TREE 列存储：基于append-only的B+树

计算单元：OLTP事务，OLAP事务，使用一个Consistent Meta进行内容统一控制（基于时间戳）

查询计划的优化使用***METIS***

## Metis

![alt](./pics/屏幕截图%202025-06-22%20164119.png)

Metis算法的基本流程，分为代价评估，计划选择和执行两部分


## Demain

代价评估基于增量存储感知模型（Demain）和基数规模进行估计

代价评估部分：

以 ***SELECT col1 FROM table WHERE col1 between ${a} and ${b}*** 为例

分布式系统的网络延迟：

![alt](./pics/屏幕截图%202025-06-22%20164705.png)

行扫描：

行条目读取：

![alt](./pics/屏幕截图%202025-06-22%20164726.png)

行索引遍历：

![alt](./pics/屏幕截图%202025-06-22%20164743.png)

列扫描：

增量树查找：

![alt](./pics/屏幕截图%202025-06-22%20164757.png)

![alt](./pics/屏幕截图%202025-06-22%20164816.png)

稳定列查找：

![alt](./pics/屏幕截图%202025-06-22%20165504.png)

总代价：

![alt](./pics/屏幕截图%202025-06-22%20164846.png)

与传统方式一样，Metis参考sel进行选取，如果sel较小会考虑直接进行行读取，避免过多的IO

相较于传统方法，Metis在计算列存储时会考虑增量B+树的遍历代价，使得其会在sel适中时更偏向行存储

定义表：

![alt](./pics/屏幕截图%202025-06-22%20172849.png)

## Visibility-aware Plan Selection

进行代价估计之后，首先排除所有远非最优的计划，然后利用Visibility-aware算法生成一系列种子计划，用于后续的进一步优化和执行：

Visibility-aware Plan Selection通过提前调度可用数据上面的预执行，从而掩盖HTAP数据库种的可见性延迟。

![alt](./pics/屏幕截图%202025-06-22%20172733.png)


可见性延迟的来源：

新的写入被提交到数据传输管道中，然后从行存储运送到列存储

传输的逻辑日志由delta-store解析

新的更新被附加到delta-store中并由 +树索引

更新被提交到delta-store中并最终对查询可见

估计方法：

Metis使用历史数据估计可见性延迟，并将OTLP的工作负载的并发映射到可见性延迟，同时全局元服务持续收集新的测量值，再运行时进行校准。计算每个并发的可见性延迟移动平均值（最后30个样本），用多项式回归曲线求解

算法流程如图:

![alt](./pics/屏幕截图%202025-06-22%20170402.png)

进行计划枚举时，将每一个物理计划表现为有向无环图。

顶点对应物理操作符。

有两种边：软依赖（后一个操作必须等待前一个操作的全部输出），软依赖（两者可以流水线执行）

执行算法时：基于 DAG 抽象，我们首先通过删除图中unavailable pending tasks来计算每个计划的预执行（pre-execution）tasks。通过这样做，我们得到了一组预执行任务（即 ）。由于 中的任务之间没有数据依赖关系，因此它们可以并行执行。因此，调度pre-execution的整体性能改进应该是最长任务的执行时间。

随后：将visibility delay的知识结合到第 18 行的计划成本中，该成本捕获了用户观察到的端到端查询延迟。

最后：使用修订后的成本来指导选择函数并生成一个具有最低查询延迟成本的visibility-aware物理计划。

未来扩展：可以将增量计算技术和列上的预执行相结合，进一步提升性能

## Proactive Query Re-optimizations

在执行查询优化时，Metis 会生成一组种子计划（即面向行的计划、面向列的计划和 HTAP 感知计划）以节省重新优化的成本。

在执行查询时，Metis 从最便宜的计划开始，并根据运行时统计数据不断重新优化计划。

种子计划：

由上面的算法给出，种子计划都具有相同的逻辑结构，但可能采用不同的物理运算符。

通常，当存在优于row-oriented和column-oriented计划的混合计划时，种子计划由三个物理计划组成；否则，种子计划由两个计划组成。不会单独优化面向行和面向列的计划的逻辑结构。

Runtime Statistics：

Metis 会根据运行时统计信息定量评估其决策的影响。为了高效执行，当估计基数与实际统计数据相差甚远（例如超过 20%）时，Metis 会重新优化物理运算符。

![alt](./pics/屏幕截图%202025-06-22%20175553.png)

Plan Stitch.

在重新优化计划时，Metis 会从种子计划中拼接子计划，而不会丢失之前的进度，重新优化本质在于对剩余未执行计划的物理运算符的选择进行重新优化。

![alt](./pics/屏幕截图%202025-06-22%20175459.png)

## Experimentations & Evaluations


